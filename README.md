<img width="1696" height="608" alt="mlup-distributed" src="https://github.com/user-attachments/assets/71523006-f42b-4bb8-ab2e-67b78f260346" />

# üöÄ MLup Distributed (Redis Queue Edition)

> –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è production-ready –≤–µ—Ä—Å–∏—è MLup  
> —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥—å—é, Redis-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

----------

# üìå –ß—Ç–æ —ç—Ç–æ?

–≠—Ç–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ **https://mlup.org**, –≤ –∫–æ—Ç–æ—Ä–æ–π:
-   –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ `worker_and_queue`
-   –æ—á–µ—Ä–µ–¥—å –∏ —Å—Ç–∞—Ç—É—Å—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ Redis
-   —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤
-   –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ (Prometheus + Grafana)
-   —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω leader election
-   —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ requeue stale jobs
-   –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
----------

# üß® –ü—Ä–æ–±–ª–µ–º–∞ –±–∞–∑–æ–≤–æ–≥–æ MLup

–í MLup —É–∂–µ –µ—Å—Ç—å [–º–µ—Ö–∞–Ω–∏–∑–º](https://mlup.org/web_app_architectures/#mlupwebarchitecturedirectly_to_predictdirectlytopredictarchitecture):



```
POST /predict ‚Üí –ø–æ–ª—É—á–∏—Ç—å predict_id  
GET /predict/{predict_id} ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

–ù–æ –≤ –±–∞–∑–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

-   —Å—Ç–∞—Ç—É—Å—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è **–≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞**
-   –æ—á–µ—Ä–µ–¥—å ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–Ω—É—Ç—Ä–∏ uvicorn worker
-   –ø—Ä–æ—Ç–æ–∫–æ–ª —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ blocking (–æ–∂–∏–¥–∞–Ω–∏–µ –¥–æ `ttl_client_wait`)
    

----------
## ‚ùó –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç

`uvicorn workers=4` 

–ü–æ–ª—É—á–∞–µ–º:
```
Process A (memory A)
Process B (memory B)
Process C (memory C)
Process D (memory D)
```

–ö–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏–º–µ–µ—Ç:

-   —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å
-   —Å–≤–æ–∏ predict_id
-   —Å–≤–æ–∏ —Å—Ç–∞—Ç—É—Å—ã

----------

## üí• –ü—Ä–æ–±–ª–µ–º–∞
```
    POST ‚Üí Process A ‚Üí memory A
    GET  ‚Üí Process C ‚Üí memory C
```
Process C –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ predict_id.

–†–µ–∑—É–ª—å—Ç–∞—Ç:
-   404
-   408
-   –ø–æ—Ç–µ—Ä—è predict_id
-   –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å sticky sessions

----------

### üö® –ë–µ–∑ sticky sessions —Å–∏—Å—Ç–µ–º–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sticky sessions, –Ω–æ:
-   —ç—Ç–æ –ª–æ–º–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
-   –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ Kubernetes
-   –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–∞–¥–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
-   –Ω–µ –¥–∞—ë—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
    

----------
## üî• –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω—è–ª POST:

-   —É–ø–∞–ª
-   –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
-   –∑–∞–¥–µ–ø–ª–æ–µ–Ω –∑–∞–Ω–æ–≤–æ

predict_id –∏—Å—á–µ–∑–∞–µ—Ç.

–ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –∂–∏–ª –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.

----------

# üí° –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏

–û—á–µ—Ä–µ–¥—å –∏ —Å—Ç–∞—Ç—É—Å –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ Redis.

–¢–µ–ø–µ—Ä—å:
-   predict_id –≥–ª–æ–±–∞–ª—å–Ω—ã–π
-   –ª—é–±–æ–π API-–ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
-   –ª—é–±–æ–π worker –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–¥–∞—á—É
-   –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å
-   —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ [mlup\web\architecture\redis_queue](https://github.com/AlexeySmirnov74/mlup-distributed/tree/main/mlup/web/architecture/redis_queue)

----------

# üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è

| –ë–∞–∑–æ–≤—ã–π MLup          | MLup Distributed                 |
| --------------------- | -------------------------------- |
| –ü–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞       | Redis                            |
| predict_id –ª–æ–∫–∞–ª—å–Ω—ã–π  | predict_id –≥–ª–æ–±–∞–ª—å–Ω—ã–π            |
| –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏ | Reliable queue                   |
| –ù–µ—Ç requeue           | Requeue stale jobs               |
| –ù–µ—Ç leader election   | Leader election —á–µ—Ä–µ–∑ Redis lock |
| –ù–µ—Ç heartbeat         | Heartbeat workers                |
| –ù–µ—Ç –º–µ—Ç—Ä–∏–∫            | Prometheus + Grafana             |
| –í–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è –∑–∞–¥–∞—á | –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –∑–∞–¥–∞—á                 |
| –ù—É–∂–µ–Ω sticky session  | –ù–µ –Ω—É–∂–µ–Ω                         |

----------

# üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

<img width="auto" height="auto" alt="image" src="https://github.com/user-attachments/assets/b0efaee6-a062-4e6f-9b3e-2bee5fde0592" />




----------

# üîÅ Leader Election

–û–¥–∏–Ω –∏–∑ –≤–æ—Ä–∫–µ—Ä–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª–∏–¥–µ—Ä–æ–º —á–µ—Ä–µ–∑ Redis lock.

Leader –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
-   –æ—á–∏—Å—Ç–∫—É dead workers
-   requeue stale inflight jobs
-   cleanup in_progress –±–µ–∑ –∂–∏–≤—ã—Ö pid
-   –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏

----------

# üîÑ Reliable Queue

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ö–µ–º–∞:

-   BRPOPLPUSH
-   processing list
-   inflight zset
-   inflight hash
-   ack —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    
–ï—Å–ª–∏ worker —É–ø–∞–ª:

-   –ª–∏–¥–µ—Ä –≤–µ—Ä–Ω—ë—Ç –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å

----------

# üìä –ú–µ—Ç—Ä–∏–∫–∏

–î–æ–±–∞–≤–ª–µ–Ω—ã:

-   http_requests_total - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API.
-   http_request_duration_seconds - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤.
-   mlup_queue_length - –¢–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏ Redis (`LLEN predict_queue`).
-   mlup_inflight - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤–∑—è—Ç—ã –≤–æ—Ä–∫–µ—Ä–æ–º, –Ω–æ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã (ACK)
-   mlup_workers_active - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∏–≤—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ –ø–æ heartbeat.
----------

# üß© Run Modes

–ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:
```
    MLUP_RUN_MODE
```
-   api ‚Äî —Ç–æ–ª—å–∫–æ API
-   worker ‚Äî —Ç–æ–ª—å–∫–æ worker loop
-   both ‚Äî –æ–±–∞ —Ä–µ–∂–∏–º–∞

----------

# üê≥ Docker Compose

–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

-   Redis
-   API
-   Workers
-   Prometheus
-   Grafana
-   Dozzle
   
----------

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```
    git clone <repo>
    cd mlup-distributed
    
    python3 -m venv venv
    source venv/bin/activate
    
    pip install --upgrade pip
    pip install -r requirements.txt
```
----------
# üì¶ –ù–∞—Å—Ç—Ä–æ–π–∫–∞

common_app.py ‚Äî —ç—Ç–æ –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MLup-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç:

- –¥–µ–º–æ –º–æ–¥–µ–ª—å (DemoStubModelSync)
- –§—É–Ω–∫—Ü–∏—é build_up(), –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç: Redis, –æ—á–µ—Ä–µ–¥—å, TTL, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (worker_and_queue), non-blocking —Ä–µ–∂–∏–º (is_long_predict=True)

app.py ‚Äî —ç—Ç–æ HTTP API —Å–ª–æ–π:

- –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å
- –∑–∞–≥—Ä—É–∂–∞–µ—Ç web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ MLup
- –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º MLUP_RUN_MODE=api
- –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ HTTP-—Å–µ—Ä–≤–µ—Ä (–±–µ–∑ –≤–æ—Ä–∫–µ—Ä-—Ü–∏–∫–ª–∞)
- –ø–æ–¥–∫–ª—é—á–∞–µ—Ç Prometheus middleware
- –ø—É–±–ª–∏–∫—É–µ—Ç /metrics
- –∑–∞–ø—É—Å–∫–∞–µ—Ç uvicorn

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:

- API –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç predict
- API —Ç–æ–ª—å–∫–æ: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç POST, –∫–ª–∞–¥—ë—Ç –∑–∞–¥–∞—á–∏ –≤ Redis, –æ—Ç–¥–∞—ë—Ç predict_id, –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ GET-–ø–æ–ª–ª–∏–Ω–≥

# üê≥ ‚ñ∂ Docker –∑–∞–ø—É—Å–∫
```
    docker compose up --build
```
–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
```
    docker compose up --scale worker=4
```
–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö –º–∞—à–∏–Ω–∞—Ö:
```
    cd workers
    docker compose -f ./docker-compose.workers.yml up --scale worker=4
```
----------

# üåç –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å workers:

-   –Ω–∞ –¥—Ä—É–≥–∏—Ö –º–∞—à–∏–Ω–∞—Ö
-   –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
-   –≤ Kubernetes
-   –≤ Docker Swarm

–ì–ª–∞–≤–Ω–æ–µ ‚Äî –¥–æ—Å—Ç—É–ø –∫ Redis.

----------

# üõ° –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ

-   –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ predict_id
-   –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ worker
-   –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å uvicorn workers
-   –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ sticky sessions
-   –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
-   Fault-tolerance
-   Production-grade –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

<img width="1530" height="814" alt="Grafana2" src="https://github.com/user-attachments/assets/702e65b5-7f25-4239-b1af-73268fc5d9f1" />

